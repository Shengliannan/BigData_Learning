[TOC]

# 从Paxos到Zookeeper

——分布式一致性原理与实践

***

### 集中式系统VS分布式系统

（1）集中式系统特点：

问题：单点问题

优点：部署结构简单，不用考虑多个节点之间分布式协作问题

（2）分布式系统特点：

- 分布性

  多台计算机在空间上随意分布，同时，机器的分布情况也会随时变动。

- 对等性

  分布式系统中的计算机没有主/从之分。

  数据副本

  为了对外提高高可用的服务，我们往往会对数据和服务进行副本处理。数据副本是指在不同的节点上持久化同一份数据，当某一个节点上存储的数据丢失时，可以从副本上读取到该数据，这是解决分布式系统数据丢失问题最为有效的手段。

  服务副本

  指多个节点提供同样的服务，每个节点都有能力接收来自外部的请求并进行相应的处理。

- 并发性

  分布式并发操作，并发的操作共享的资源

- 缺乏全局时钟

  分布式系统的时钟和事件顺序

- 故障总是会发生

  任何在设计阶段考虑到的异常情况，一定会在系统实际运行中发生，并且，在系统实际运行过程中还会遇到很多在设计时未能考虑到的异常故障。

分布式环境的问题：

- 通信异常
- 网络分区（脑裂，局部小集群）
- 三态（成功，失败与超时）
- 节点故障



### 分布式系统的概念

***分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和系统的系统。***

### 分布式理论

- ACID（集中式的事务处理系统）

  事务（Transcation）是一系列对系统中数据进行访问与更新操作所组成的一个程序执行逻辑单元（Unit），狭义上的事务特制数据库事务。

  事务具有四个特性：

  1. 原子性（Automicity）

     事务的原子性是指事务必须是一个原子的操作序列单元。事务中包含的各项操作在一次执行过程中，只允许出现以下两种状态之一。

     - 全部成功执行。
     - 全部不执行。

  2. 一致性（Consistency）

     只包含成功事务提交的结果；如果数据库系统在运行过程中发生故障，有些事务尚未完成就被迫中断，这些未完成的事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是不一致的状态。

  3. 隔离性（Isolation）

     事务的隔离性是指在并发环境中，并发的事务是相互隔离的，一个事务的执行不能被其他事务干扰。

     在标准SQL规范中，定义了4个事务隔离级别，不同的隔离级别对事务的处理不同：

     > [参考](https://www.cnblogs.com/s-b-b/p/5845096.html)

     - 未授权读取

       为授权读取也成为读为提交（Read Uncommitted），该隔离级别允许脏读取，其隔离级别最低。事务B可以看到事务A未提交的事务的中间操作值。

     - 授权读取

       授权读取也被称为读已提交（Read Committed）。

     - 可重复读

       幻读

     - 可串行化

***
事务隔离级别越高，就越能保证数据的完整性和一致性，但同时对并发性能的影响也越大。通常，对于绝大多数的应用程序来说，可以优先考虑数据库系统的隔离级别设置为授权读取，这能够在避免脏读读取的同时保证较好的并发性能。尽管这种事务隔离级别会导致不可重复读、虚读和第二类丢失更新等并发问题，但较为科学的做法是在可能出现这类问题的个别场合中，由应用程序主动采用悲观锁或乐观锁来进行事务控制。
***
  4. 持久性（Durability）

- CAP（分布式事务）

  CAP定理：

  一个分布式系统不可能同时满足一致性（C:Consistency）、可用性（A:Availability）和分区容错性（P:Partition tolerance)这三个基本需求，最多只能同时满足其中的两项。

  ***注：分区是指网络分区***

  对于一个分布式系统而言，分区容错性是一个最基本的要求。一般根据业务特点在C(一致性）和A(可用性)之间需求平衡。

- BASE

  BASE是Basically Availabe（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的简写。BASE是对CAP中一致性和可用性权衡的结果。

  ***注：弱状态也称为软状态，和硬状态相对，是指允许系统中的数据存在中间状态，允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。***

  ***
  总的来说，BASE理论面向的是大型高可用可扩展的分布式的分布式系统，和传统事务的ACID特性是相反的，它完全不同于ACID的强一致模型，而是提出通过牺牲强一致性来获得可用性，并允许数据在一段时间是不一致的，但最终达到一致状态。但同时，在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统架构设计过程中，ACID特性与BASE理论往往又会结合在一起使用。

  ***

### 分布式一致性问题

- 数据复制（数据一致性）

  存在复制延迟

  一致性级别：强一致性、弱一致性、最终一致性

- 一致性模型

  弱一致性

  强一致性

   	1. 同步
   	2. Paxos
   	3. Raft（multi-paxos）
   	4. ZAB（multi-paxos）

- 一致性协议：

  2PC（二阶段提交协议）

  阶段一：提交事务请求

  阶段二：执行事务提交

  是计算机网络尤其是在数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性而设计的一种算法。通常，二阶段提交协议也被认为是一种一致性协议，用来保证分布式系统数据的一致性。目前，绝大部分的关系型数据都都是采用二阶段提交协议来完成***分布式事务***处理的。

  优缺点：

  二阶段提交协议的优缺点：原理简单，实现方便。

  二阶段提交的缺点：同步阻塞、单点问题、脑裂、太过保守。

  3PC（三阶段提交协议）

  阶段一：CanCommit

  阶段二：PreCommit

  阶段三：doCommit

- Paxos算法详解

  步骤、阶段

  1. Prepare

     proposer提出一个提案，编号为N，此N大于这个proposer之前提出提案编号，请求acceptors的quorum接受。

  2. Promise

     如果N大于acceptors之前接受的任何天编号则接受，否则拒绝。

  3. Accept

     如果达到了多数派，proposer会发出accept请求，此请求包提案编号N，以及提案内容。

  4. Accepted

     如果此acceptor在此期间没有收到任何编号大于N的提案，则接受此提案内容，否则忽略。

  Basic Paxos：难实现，效率低（2轮RPC）、活锁。

  paxos其实是一个共识算法。系统的最终一致性，不仅需要达到共识，还要取决于client的行为。

  角色：

  Client：系统外部角色，请求发起者。像民众。

  Proposer：接受Client请求，向集群提出提议（propose）。并在冲突发生时，起到冲突调节作用。像议员，替民众提出议案。

  Acceptor（Voter）：提议投票和接受者，只有在形成法定人数（Quorum，一般即为majority多数派）时，提议才会最终被接受。像国会。

  Learner：提议接受者，backup，备份，对集群一致性没什么影响，像记录员。

  存在问题：

  活锁

  议员A提出提案1，yiyuanB提出提案2，因为2>1，讨论提案2，A又提出提案3，内容不变，这样往复，就一直循环下去。

  解决方案：设置一个random time out，冲突等一段时间。可能议员B的提案2完成。

  Raft（简单版本的Paxos）

  [原理动画解释](http://thesecretlivesofdata.com/raft/)

  [场景测试](https://raft.github.io)

   - 划分为三个子问题：

     Leader Election

     Log Replication

     Safety

  - 重定义角色：

    Leader

    Follower

    Candidate

  ZAB（zookeeper共识算法）

  基本与raft相同。

  在一些名词的叫法上有些区别：如ZAB将某一个leader的周期称为epoch，而raft则称为term。

  实现上有而些许不同：如raft保证日志连续性，心跳方向为leader至follower。ZAB则相反。

### 分布式事务

### 分布式锁

- Chubby
一个分布式锁服务的目的是允许它的客户端进程同步彼此的操作，并对当前所处环境的基本状态信息达成一致。

### 分布式一致性协议

- 2PC
- 3PC
- Paxos
- ZAB（Zookeeper使用）

### 应用场景

火车票购买、银行转账、网上购物

### Zookeeper架构
ZAB协议
ZAB（ZooKeeper Atomic Broadcast,Zookeeper原子消息广播协议）
ZAB协议包括两种基本模式
崩溃恢复
消息广播

Zookeeper是一个典型的分布式数据一致性的解决方案，分布式应用程序可以基于它实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列等功能。

通常在分布式系统中，构成一个集群的每一台机器都有自己的角色，最典型的集群模式就是Master/Slave模式（主备模式）。

而在ZooKeeper中，没有沿用传统的Master/Slave概念，而是引入了Leader、Follower和Obeerver三种角色。
客户端连接是客户端和服务器之间的一个TCP长连接。
Zookeeper节点——
             |——机器节点
             |——数据节点（Znode）
                   |——临时节点（生命周期和客户端会话绑定）
                   |——持久节点
- 系统模型
- Leader选举
- 客户端与服务端的工作原理
- 请求处理
- 服务器角色工作流程
- 数据存储

P179